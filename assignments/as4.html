<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Assignment 4: Code Generation - The Patina Programming Language</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../overview/overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../overview/integer.html"><strong aria-hidden="true">1.1.</strong> Integer Expressions</a></li><li class="chapter-item expanded "><a href="../overview/boolean.html"><strong aria-hidden="true">1.2.</strong> Boolean Expressions</a></li><li class="chapter-item expanded "><a href="../overview/unit.html"><strong aria-hidden="true">1.3.</strong> Unit Expressions</a></li><li class="chapter-item expanded "><a href="../overview/arrays.html"><strong aria-hidden="true">1.4.</strong> Arrays</a></li><li class="chapter-item expanded "><a href="../overview/functions.html"><strong aria-hidden="true">1.5.</strong> Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../ref.html"><strong aria-hidden="true">2.</strong> Reference Manual</a></li><li class="chapter-item expanded "><a href="../setup/setup.html"><strong aria-hidden="true">3.</strong> Setting up OCaml</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../setup/opam.html"><strong aria-hidden="true">3.1.</strong> Installing opam</a></li><li class="chapter-item expanded "><a href="../setup/ocaml.html"><strong aria-hidden="true">3.2.</strong> Installing OCaml</a></li><li class="chapter-item expanded "><a href="../setup/run.html"><strong aria-hidden="true">3.3.</strong> Interacting with OCaml Code</a></li></ol></li><li class="chapter-item expanded "><a href="../assignments/assignments.html"><strong aria-hidden="true">4.</strong> Programming Assignments</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../assignments/as1.html"><strong aria-hidden="true">4.1.</strong> Assignment 1: OCaml</a></li><li class="chapter-item expanded "><a href="../assignments/as2.html"><strong aria-hidden="true">4.2.</strong> Assignment 2: Lexing and Parsing</a></li><li class="chapter-item expanded "><a href="../assignments/as3.html"><strong aria-hidden="true">4.3.</strong> Assignment 3: Type Checking</a></li><li class="chapter-item expanded "><a href="../assignments/as4.html" class="active"><strong aria-hidden="true">4.4.</strong> Assignment 4: Code Generation</a></li><li class="chapter-item expanded "><a href="../assignments/as5.html"><strong aria-hidden="true">4.5.</strong> Assignment 5: Optimizations</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Patina Programming Language</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="cs160-assignment-4-code-generation"><a class="header" href="#cs160-assignment-4-code-generation">CS160 Assignment 4: Code Generation</a></h2>
<p>Your compiler will generate x86 assembly code for Patina programs.</p>
<p>For this assignment, you will tackling the most central part of a compiler: the generation of code of a lower level language. In this case, we will be using x86 as the target language. <a href="https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf">Cheat sheet #1</a> <a href="http://www.cs.cmu.edu/afs/cs/academic/class/15213-s20/www/recitations/x86-cheat-sheet.pdf">Cheat sheet #2</a></p>
<p>This would normally be far more difficult than each of the other individual stages of the compiler. However, we have introduced a number of simplifications to make it doable.</p>
<ol>
<li>
<p>Function calls are disallowed, and any functions besides main. In essence, the patina files to be compiled will represent a simple script. (Functions will be included in bonus part #1.)</p>
</li>
<li>
<p>Arrays are no longer included in the language specification. This allows all data to be stored on the stack as supposed to on the heap. (Arrays will be included in bonus part #2.)</p>
</li>
<li>
<p>This matters for performance but not to correctness, no register allocation algorithm needs to be written. All data will be stored inside a single frame of the stack. </p>
</li>
</ol>
<p>However, this still leaves a fair amount of complexity. For example, the following function calculating fibonacci numbers is still allowed.</p>
<pre><code>	fn main() -&gt; unit {
		let fibn : int = 10;
		let firstval : int = 1;
		let secondval : int = 1;
		if (fibn &lt; 0) then
			{let res : int = 0/0} else
		{
			while (fibn &gt; 0){
				let sum : int = firstval + secondval;
				firstval = secondval;
				secondval = sum;
				fibn = fibn - 1
			};
			let res : int = secondval
		}
	}
</code></pre>
<p>As you can see, this still contains the challenges for implementation of</p>
<ol>
<li>jumps required for while loops and if expressions</li>
<li>binop expressions which when compiled require multiple lines of assembly.</li>
</ol>
<p>For the former, you will be adding labels into the assembly to allow appropriate jumps. For example, the expression {if 0 then {2} else {1} + 1} should be translated into something equivalent to the following (ignore the binop compilation there for now).</p>
<pre><code>	cmp $0 $1
	je L1
	mov $1 %rax
	jmp L2
	L1:
	mov $2 %rax
	L2:
	add %rax $1
</code></pre>
<p>For the latter, you will be reading variables from the stack into some fixed registers, pushing them onto the stack temporarily to allow for arbitrary depth arithmetic trees, and then writing them back there. For example, the expression x = x * 4 should be translated into something equivalent to the following (which is inefficient, but you only need correctness for now.)</p>
<pre><code>	mov 16(%rbp) %rax
	push %rax
	mov $4 %rax
	mov %rax %rbx
	pop %rax
	add %rbx %rax
	mov %rax 16(%rbp)
</code></pre>
<h1 id="mandatory-part---loops-conditionals-and-variables"><a class="header" href="#mandatory-part---loops-conditionals-and-variables">Mandatory Part - Loops, Conditionals, and Variables</a></h1>
<p>Fill in the holes in the provided code, so that the <code>compile</code> function correctly converts an AST from the following subset of Patina to x86 assembly.</p>
<pre><code>type expr =
  | Const of const
  | Id of string
  | Let of string * typ * expr
  | Assign of string * expr
  | Unary of unop * expr
  | Binary of binop * expr * expr
  | Ite of expr * expr * expr  
  | Seq of expr list
  | While of expr * expr
</code></pre>
<h1 id="bonus-part-1---functions"><a class="header" href="#bonus-part-1---functions">Bonus Part 1 - Functions</a></h1>
<p>TBF</p>
<h1 id="bonus-part-2---arrays"><a class="header" href="#bonus-part-2---arrays">Bonus Part 2 - Arrays</a></h1>
<p>TBF</p>
<!-- TODO: Provide a more precise specification of the dynamic semantics of Patina -->
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../assignments/as3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../assignments/as5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../assignments/as3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../assignments/as5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
